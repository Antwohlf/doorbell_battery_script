name: Wyze Doorbell Battery Monitor

on:
  # Weekly schedule at 9 AM UTC on Mondays
  schedule:
    - cron: '0 9 * * 1'

  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      force_alert:
        description: 'Send test alert regardless of battery level'
        required: false
        default: 'false'
        type: boolean
      explore_mode:
        description: 'Run in exploration mode to discover devices'
        required: false
        default: 'false'
        type: boolean

jobs:
  check-battery:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run battery monitor
        env:
          # Wyze credentials
          WYZE_EMAIL: ${{ secrets.WYZE_EMAIL }}
          WYZE_PASSWORD: ${{ secrets.WYZE_PASSWORD }}
          WYZE_KEY_ID: ${{ secrets.WYZE_KEY_ID }}
          WYZE_API_KEY: ${{ secrets.WYZE_API_KEY }}

          # Notification settings (Resend)
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}

          # Configuration
          BATTERY_THRESHOLD: '20'
          FORCE_ALERT: ${{ github.event.inputs.force_alert || 'false' }}
          EXPLORE_MODE: ${{ github.event.inputs.explore_mode || 'false' }}
        run: python monitor.py
